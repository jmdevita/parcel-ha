# Created by @georgefahmy
# Note: intended to be wrapped in a bubble card popup as a detailed view.

type: markdown
content: >-
  {% set raw = state_attr('sensor.parcel_raw_shipment_data', 'deliveries') %}
  {% set ns = namespace(deliveries = []) %}
  {% for order in raw | selectattr('status_code','>',0) %}
    {% if order.date_expected is defined %}
      {% set sort_date = as_datetime(order.date_expected).date() %}
      {% set display_date = as_datetime(order.date_expected).date() %}
    {% else %}
      {% set sort_date = as_datetime('9999-12-31').date() %}
      {% set display_date = 'none' %}
    {% endif %}
    {% set ns.deliveries = ns.deliveries + [ order | combine({'sort_date': sort_date, 'display_date': display_date}) ] %}
  {% endfor %}
  {% set deliveries = ns.deliveries | sort(attribute='sort_date') %}
  {% set delivered = raw | selectattr('status_code','eq',0) | list %}

  # Deliveries
  {% if delivered | length > 0 %}
    ## Delivered Packages
    {% for delivery in delivered %}
    _{{ delivery.description }}_ on {{ delivery.events[0].date }}
    {% endfor %}
  {% endif %}

  {% if deliveries | length > 0%}
    ## In Progress
    {% for delivery in deliveries %}    
    #### {{ delivery.description }}
      - Estimated - __{{ delivery.display_date }}__
      - Latest Update - {{ delivery.events[0].date }}: _{{ delivery.events[0].event }}_
      - Tracking Number: _{{delivery.tracking_number }}_
    {% endfor %}
  {% else %}
    No Scheduled Deliveries
  {% endif %}